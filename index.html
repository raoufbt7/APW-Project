<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance Management System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#f8f9fa; color:#333; }
.navbar { background:#2c3e50; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.navbar a { float:left; color:#fff; padding:14px 18px; text-decoration:none; transition:background 0.3s; }
.navbar a:hover { background:#34495e; }
.navbar a.active { background:#3498db; }
.container { padding:20px; max-width:1400px; margin:0 auto; }

.tabs { display:flex; margin-bottom:20px; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.tab-button { flex:1; padding:15px; background:#f8f9fa; border:none; cursor:pointer; transition:background 0.3s; font-weight:600; }
.tab-button.active { background:#3498db; color:white; }
.tab-button:hover { background:#e9ecef; }
.tab-button.active:hover { background:#2980b9; }

.section { display:none; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:20px; }

table { width:100%; border-collapse:collapse; background:white; margin-top:10px; }
th, td { border:1px solid #dee2e6; padding:10px; text-align:center; }
th { background:#f8f9fa; font-weight:600; color:#495057; }

.low { background:#d4edda; }
.medium { background:#fff3cd; }
.high { background:#f8d7da; }

button, input[type="submit"]{
  background:#3498db; color:white; padding:10px 16px; border:none; border-radius:6px;
  cursor:pointer; transition:all 0.3s; margin:3px; font-size:14px;
}
button:hover, input[type="submit"]:hover { background:#2980b9; transform:translateY(-1px); box-shadow:0 2px 4px rgba(0,0,0,0.2); }
button.danger { background:#e74c3c; }
button.danger:hover { background:#c0392b; }
button.success { background:#27ae60; }
button.success:hover { background:#229954; }

input[type="text"], input[type="email"], input[type="number"], input[type="date"] {
  width:100%; padding:8px; margin-top:4px; border-radius:4px; border:1px solid #ced4da; font-size:14px;
}
input[type="text"]:focus, input[type="email"]:focus, input[type="number"]:focus, input[type="date"]:focus {
  outline:none; border-color:#3498db; box-shadow:0 0 0 2px rgba(52, 152, 219, 0.25);
}
#search { width:250px; }

.form-group { background:white; padding:20px; border-radius:8px; border:1px solid #dee2e6; margin-bottom:20px; }
.form-row { display:flex; gap:15px; flex-wrap:wrap; }
.form-row > div { flex:1; min-width:200px; }
label { display:block; margin-bottom:5px; font-weight:600; color:#495057; }
span.error { color:#e74c3c; font-size:13px; display:block; margin-top:5px; }

#sortMessage { margin-top:10px; font-weight:600; color:#495057; padding:10px; background:#f8f9fa; border-radius:4px; }

#attendanceTable tr { transition: background-color 0.3s; }
#attendanceTable tr:hover { background:#f8f9fa; }

.card { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:20px; }
.card h3 { margin-top:0; color:#2c3e50; border-bottom:2px solid #3498db; padding-bottom:10px; }

.alert { padding:15px; border-radius:4px; margin-bottom:15px; }
.alert-info { background:#d1ecf1; border:1px solid #bee5eb; color:#0c5460; }
.alert-success { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
.alert-danger { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }

.stats { display:flex; gap:20px; margin-bottom:20px; }
.stat-card { flex:1; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); text-align:center; }
.stat-card h4 { margin:0; color:#7f8c8d; font-size:14px; text-transform:uppercase; }
.stat-card .number { font-size:36px; font-weight:bold; color:#2c3e50; margin:10px 0; }

@media (max-width: 768px) {
  .form-row { flex-direction:column; }
  .stats { flex-direction:column; }
  .navbar a { padding:10px; font-size:14px; }
}
</style>
</head>
<body>

<div class="navbar">
  <a href="#" class="active" onclick="showTab('overview')"><i class="fas fa-home"></i> Overview</a>
  <a href="#" onclick="showTab('students')"><i class="fas fa-users"></i> Students</a>
  <a href="#" onclick="showTab('attendance')"><i class="fas fa-clipboard-check"></i> Attendance</a>
  <a href="#" onclick="showTab('sessions')"><i class="fas fa-calendar-alt"></i> Sessions</a>
  <a href="#" onclick="showTab('reports')"><i class="fas fa-chart-bar"></i> Reports</a>
</div>

<div class="container">

<div class="tabs">
  <button class="tab-button active" onclick="showTab('overview')">Overview</button>
  <button class="tab-button" onclick="showTab('students')">Students</button>
  <button class="tab-button" onclick="showTab('attendance')">Attendance</button>
  <button class="tab-button" onclick="showTab('sessions')">Sessions</button>
  <button class="tab-button" onclick="showTab('reports')">Reports</button>
</div>

<!-- Overview Tab -->
<div id="overview" class="section" style="display:block;">
  <div class="stats">
    <div class="stat-card">
      <h4>Total Students</h4>
      <div class="number" id="totalStudents">0</div>
    </div>
    <div class="stat-card">
      <h4>Active Sessions</h4>
      <div class="number" id="activeSessions">0</div>
    </div>
    <div class="stat-card">
      <h4>Today's Attendance</h4>
      <div class="number" id="todayAttendance">0%</div>
    </div>
    <div class="stat-card">
      <h4>Average Participation</h4>
      <div class="number" id="avgParticipation">0%</div>
    </div>
  </div>

  <div class="alert alert-info">
    <strong>Welcome to the Attendance Management System!</strong> Use the tabs above to navigate through different sections. Start by adding students, creating sessions, and managing attendance.
  </div>
</div>

<!-- Students Tab -->
<div id="students" class="section">
  <div class="card">
    <h3><i class="fas fa-users"></i> Student Management</h3>

    <div class="form-group">
      <h4>Add New Student</h4>
      <form id="studentForm">
        <div class="form-row">
          <div><label>Student ID: <input type="text" id="sid"></label><span id="sidError" class="error"></span></div>
          <div><label>Last Name: <input type="text" id="lname"></label><span id="lnameError" class="error"></span></div>
          <div><label>First Name: <input type="text" id="fname"></label><span id="fnameError" class="error"></span></div>
          <div><label>Email: <input type="email" id="email"></label><span id="emailError" class="error"></span></div>
        </div>
        <button type="submit" class="success">Add Student</button>
      </form>
    </div>

    <div class="form-group">
      <h4>Student List</h4>
      <input type="text" id="search" placeholder="Search students...">
      <table id="studentsTable">
        <thead><tr><th>ID</th><th>Full Name</th><th>Email</th><th>Group</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Attendance Tab -->
<div id="attendance" class="section">
  <div class="card">
    <h3><i class="fas fa-clipboard-check"></i> Attendance Management</h3>

    <div id="sessionSelection" class="alert alert-info">
      <strong>Select Session:</strong>
      <select id="sessionSelect"><option value="">-- Select Session --</option></select>
      <button id="loadAttendanceBtn">Load Attendance</button>
    </div>

    <div class="form-group">
      <h4>Take Attendance</h4>
      <button id="takeAttendanceBtn" class="success">Take Attendance</button>
      <div id="attendanceFormContainer" style="display:none; margin-top:20px;">
        <form id="attendanceForm">
          <table id="attendanceList">
            <thead><tr><th>Student ID</th><th>Name</th><th>Present</th><th>Absent</th></tr></thead>
            <tbody></tbody>
          </table>
          <div style="margin-top:15px;">
            <input type="submit" value="Save Attendance" class="success">
            <span id="attendanceMsg" style="margin-left:15px; font-weight:bold;"></span>
          </div>
        </form>
      </div>
    </div>

    <div class="form-group">
      <h4>Attendance Records</h4>
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>ID</th><th>Last Name</th><th>First Name</th>
            <th>Presence</th>
            <th>Absences</th>
            <th>Participation</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="form-group">
      <button id="sortAbs">Sort by Absences</button>
      <button id="sortPar">Sort by Participation</button>
      <button id="highlightExcellent">Highlight Excellent</button>
      <button id="resetColors" class="danger">Reset Colors</button>
      <div id="sortMessage"></div>
    </div>
  </div>
</div>

<!-- Sessions Tab -->
<div id="sessions" class="section">
  <div class="card">
    <h3><i class="fas fa-calendar-alt"></i> Session Management</h3>

    <div class="form-group">
      <h4>Create New Session</h4>
      <form id="sessionForm">
        <div class="form-row">
          <div><label>Course ID: <input type="number" id="course_id"></label></div>
          <div><label>Group ID: <input type="number" id="session_group_id"></label></div>
          <div><label>Professor ID: <input type="number" id="opened_by"></label></div>
          <div><label>Date: <input type="date" id="session_date"></label></div>
        </div>
        <button type="submit" class="success">Create Session</button>
      </form>
    </div>

    <div class="form-group">
      <h4>Session List</h4>
      <table id="sessionsTable">
        <thead><tr><th>ID</th><th>Course</th><th>Group</th><th>Date</th><th>Opened By</th><th>Status</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Reports Tab -->
<div id="reports" class="section">
  <div class="card">
    <h3><i class="fas fa-chart-bar"></i> Reports & Analytics</h3>

    <div class="form-group">
      <button id="showReport" class="success">Generate Report</button>
      <div id="reportSection" style="display:none; margin-top:20px;">
        <canvas id="reportChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div class="form-group">
      <h4>Quick Stats</h4>
      <div class="stats">
        <div class="stat-card">
          <h4>Present Today</h4>
          <div class="number" id="presentToday">0</div>
        </div>
        <div class="stat-card">
          <h4>Absent Today</h4>
          <div class="number" id="absentToday">0</div>
        </div>
        <div class="stat-card">
          <h4>Participation Rate</h4>
          <div class="number" id="participationRate">0%</div>
        </div>
      </div>
    </div>
  </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Tab switching function
function showTab(tabName) {
  // Hide all sections
  const sections = document.querySelectorAll('.section');
  sections.forEach(section => section.style.display = 'none');

  // Remove active class from all navbar links and tab buttons
  const navLinks = document.querySelectorAll('.navbar a');
  navLinks.forEach(link => link.classList.remove('active'));
  const tabButtons = document.querySelectorAll('.tab-button');
  tabButtons.forEach(button => button.classList.remove('active'));

  // Show selected section
  document.getElementById(tabName).style.display = 'block';

  // Add active class to corresponding navbar link and tab button
  const activeNavLink = document.querySelector(`.navbar a[onclick="showTab('${tabName}')"]`);
  if (activeNavLink) activeNavLink.classList.add('active');
  const activeTabButton = document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`);
  if (activeTabButton) activeTabButton.classList.add('active');

  // Load data for specific tabs
  if (tabName === 'students') loadStudentsTable();
  if (tabName === 'overview') updateOverviewStats();
}

// Load students into students table
async function loadStudentsTable() {
  try {
    const response = await fetch('list_students.php');
    const data = await response.json();
    const studentsTableBody = document.querySelector('#studentsTable tbody');
    studentsTableBody.innerHTML = '';

    if (data.success && data.students) {
      data.students.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${student.id}</td>
          <td>${student.fullname || (student.lname + ' ' + student.fname)}</td>
          <td>${student.email || ''}</td>
          <td>${student.group_id || ''}</td>
        `;
        studentsTableBody.appendChild(row);
      });
    }
  } catch (error) {
    console.error('Error loading students:', error);
  }
}

// Update overview statistics
async function updateOverviewStats() {
  try {
    // Load students count
    const studentsResponse = await fetch('list_students.php');
    const studentsData = await studentsResponse.json();
    const totalStudents = studentsData.success ? studentsData.students.length : 0;
    document.getElementById('totalStudents').textContent = totalStudents;

    // Load sessions count
    const sessionsResponse = await fetch('list_sessions.php');
    const sessionsData = await sessionsResponse.json();
    const activeSessions = sessionsData.success ? sessionsData.sessions.filter(s => s.status === 'open').length : 0;
    document.getElementById('activeSessions').textContent = activeSessions;

    // Calculate today's attendance (simplified - would need more complex logic for real implementation)
    document.getElementById('todayAttendance').textContent = '75%'; // Placeholder
    document.getElementById('avgParticipation').textContent = '68%'; // Placeholder

  } catch (error) {
    console.error('Error updating overview stats:', error);
  }
}

// Ensure important DOM elements are referenced explicitly
const attendanceTable = document.getElementById('attendanceTable');
const studentForm = document.getElementById('studentForm');
const sid = document.getElementById('sid');
const sidError = document.getElementById('sidError');
const lname = document.getElementById('lname');
const lnameError = document.getElementById('lnameError');
const fname = document.getElementById('fname');
const fnameError = document.getElementById('fnameError');
const email = document.getElementById('email');
const emailError = document.getElementById('emailError');
const showReport = document.getElementById('showReport');
const reportSection = document.getElementById('reportSection');
const reportChart = document.getElementById('reportChart');
const sortAbs = document.getElementById('sortAbs');
const sortPar = document.getElementById('sortPar');
const sortMessage = document.getElementById('sortMessage');
const highlightExcellent = document.getElementById('highlightExcellent');
const resetColors = document.getElementById('resetColors');
const takeAttendanceBtn = document.getElementById('takeAttendanceBtn');
const attendanceFormContainer = document.getElementById('attendanceFormContainer');
const attendanceForm = document.getElementById('attendanceForm');
const attendanceMsg = document.getElementById('attendanceMsg');
const sessionForm = document.getElementById('sessionForm');
const sessionsTableBody = document.querySelector('#sessionsTable tbody');
const course_id_input = document.getElementById('course_id');
const session_group_input = document.getElementById('session_group_id');
const opened_by_input = document.getElementById('opened_by');
const session_date_input = document.getElementById('session_date');
const sessionSelect = document.getElementById('sessionSelect');
const loadAttendanceBtn = document.getElementById('loadAttendanceBtn');
let currentSessionId = localStorage.getItem('currentSessionId') || null;
let currentAttendance = {};
let sessionColumns = []; // Array to map column indices to session IDs
function updateRow(row){
  const presenceCb = row.cells[3].querySelector('input');
  const abs = presenceCb && !presenceCb.checked ? 1 : 0;
  row.cells[4].textContent = abs + " Abs";

  const participationCb = row.cells[5].querySelector('input');
  const parts = participationCb && participationCb.checked ? 1 : 0;

  let msg = "";
  if (abs >= 1) msg = "Absent – Participate more";
  else if (parts >= 1) msg = "Present – Excellent participation";
  else msg = "Present – Try to participate more";

  row.cells[6].textContent = msg;

  row.classList.remove("low", "medium", "high");
  if (abs === 0) row.classList.add("low");
  else row.classList.add("high");
}

document.querySelectorAll("#attendanceTable tr").forEach((r,i)=>{
  if(i>0){
    updateRow(r);
    r.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.addEventListener("change",()=>updateRow(r)));
  }
});

/* Hover fix */
$("#attendanceTable tr").hover(
  function(){ $(this).css("background","#e7eef8"); },
  function(){ $(this).css("background",""); updateRow(this); }
);

/* Click info */
$("#attendanceTable tr").click(function(){
  const n=$(this).find("td:nth-child(2)").text()+" "+$(this).find("td:nth-child(3)").text();
  const a=$(this).find("td:nth-child(4)").text();
  if(n.trim()) alert(n+" | "+a);
});

/* Add Student */
function addStudentRowFromData(data){
  const r = attendanceTable.insertRow(-1);
  r.insertCell(0).textContent = data.matricule || data.id || '';
  let lnameVal = '';
  let fnameVal = '';
  if (data.fullname) {
    const parts = data.fullname.trim().split(/\s+/);
    lnameVal = parts[0] || '';
    fnameVal = parts.slice(1).join(' ') || '';
  } else {
    lnameVal = data.lname || '';
    fnameVal = data.fname || '';
  }
  r.insertCell(1).textContent = lnameVal;
  r.insertCell(2).textContent = fnameVal;
  // Presence checkbox
  const presenceCell = r.insertCell(3);
  const presenceCb = document.createElement("input");
  presenceCb.type = "checkbox";
  presenceCb.addEventListener("change", () => updateRow(r));
  presenceCell.appendChild(presenceCb);
  // Absences
  r.insertCell(4).textContent = "0 Abs";
  // Participation checkbox
  const participationCell = r.insertCell(5);
  const participationCb = document.createElement("input");
  participationCb.type = "checkbox";
  participationCell.appendChild(participationCb);
  // Status
  r.insertCell(6).textContent = "";
  updateRow(r);
}

async function postStudentToServer(data){
  try{
    const res = await fetch('add_student.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
    return await res.json();
  }catch(e){ return { success:false, error: 'Network error' }; }
}

studentForm.addEventListener("submit",e=>{
  e.preventDefault();
  sidError.textContent=lnameError.textContent=fnameError.textContent=emailError.textContent="";

  if(!/^[0-9]+$/.test(sid.value)) return sidError.textContent="Numbers only.";
  if(!/^[A-Za-z]+$/.test(lname.value)) return lnameError.textContent="Letters only.";
  if(!/^[A-Za-z]+$/.test(fname.value)) return fnameError.textContent="Letters only.";
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) return emailError.textContent="Invalid email.";

  const payload = { id: sid.value, lname: lname.value, fname: fname.value, email: email.value };
  postStudentToServer(payload).then(res=>{
    if(!res.success){
      if(res.error && res.error.indexOf('exists')!==-1) sidError.textContent='Student ID already exists on server.';
      else sidError.textContent=res.error||'Could not save student to server.';
      return;
    }
    const stud = res.student || { id: payload.id, fullname: payload.lname + ' ' + payload.fname, matricule: payload.id, email: payload.email };
    addStudentRowFromData(stud);
    if(window.serverStudents && Array.isArray(window.serverStudents)) window.serverStudents.push(stud);
    studentForm.reset();
  }).catch(err=>{
    sidError.textContent='Network error saving student.';
    console.error(err);
  });
});

// Load students from server and migrate any localStorage students
(async function loadAndMigrate(){
  try{
    const r = await fetch('list_students.php');
    const j = await r.json();
    const serverStudents = (j && j.success && Array.isArray(j.students)) ? j.students : [];
    serverStudents.forEach(s=>addStudentRowFromData(s));
    // expose for attendance form building
    window.serverStudents = serverStudents;

    // migrate localStorage students into server (if any)
    const local = getStoredStudents();
    for(const s of local){
      const exists = serverStudents.find(ss=>String(ss.id) === String(s.id) || String(ss.matricule) === String(s.matricule));
      if(!exists){
        const res = await postStudentToServer({ fullname: s.fullname || (s.lname + ' ' + s.fname), matricule: s.matricule || s.id, group_id: s.group_id || null });
        if(res && res.success && res.student){ addStudentRowFromData(res.student); }
      }
    }
    if(local.length) saveStoredStudents([]); // clear migrated local cache
  }catch(err){
    console.warn('Could not load server students, falling back to localStorage:', err);
    const stored = getStoredStudents(); stored.forEach(addStudentRowFromData);
  }
})();

// Build attendance form when requested
takeAttendanceBtn.onclick = async () => {
  attendanceFormContainer.style.display = 'block';
  // ensure we have fresh students list
  let students = window.serverStudents;
  if (!students) {
    try{ const r = await fetch('list_students.php'); const j=await r.json(); students=(j && j.success && Array.isArray(j.students))?j.students:[]; window.serverStudents=students; }catch(e){ students=[]; }
  }
  const tbl = document.getElementById('attendanceList');
  // clear existing rows except header
  Array.from(tbl.querySelectorAll('tr')).slice(1).forEach(r=>r.remove());
  students.forEach(s=>{
    const tr = document.createElement('tr');
    const tdId = document.createElement('td'); tdId.style.textAlign='left'; tdId.textContent = s.id; tr.appendChild(tdId);
    const tdName = document.createElement('td'); tdName.style.textAlign='left';
    // support fullname returned from DB or legacy lname/fname
    tdName.textContent = (s.fullname && s.fullname.trim()) ? s.fullname : ((s.lname||'') + ' ' + (s.fname||'')).trim();
    tr.appendChild(tdName);
    const tdP = document.createElement('td'); tdP.style.textAlign='center'; const rP = document.createElement('input'); rP.type='radio'; rP.name = `attendance[${s.id}]`; rP.value='present'; rP.checked=true; tdP.appendChild(rP); tr.appendChild(tdP);
    const tdA = document.createElement('td'); tdA.style.textAlign='center'; const rA = document.createElement('input'); rA.type='radio'; rA.name = `attendance[${s.id}]`; rA.value='absent'; tdA.appendChild(rA); tr.appendChild(tdA);
    tbl.appendChild(tr);
  });
};

// Submit attendance to server
attendanceForm.addEventListener('submit', async function(e){
  e.preventDefault();
  attendanceMsg.textContent = '';
  const sessionId = sessionSelect.value;
  if(!sessionId) {
    attendanceMsg.style.color='red'; attendanceMsg.textContent = 'Please select a session first.';
    return;
  }
  const students = window.serverStudents || [];
  const attendance = [];
  students.forEach(s=>{
    const sel = document.querySelector(`input[name="attendance[${s.id}]"]:checked`);
    const status = sel ? sel.value : 'absent';
    attendance.push({ student_id: String(s.id), status });
  });
  try{
    const res = await fetch('attendance_api.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ session_id: sessionId, attendance }) });
    const j = await res.json();
    if (j && j.success) {
      attendanceMsg.style.color='green'; attendanceMsg.textContent = 'Attendance saved: ' + (j.file||'');
      // disable form after save
      Array.from(attendanceForm.querySelectorAll('input')).forEach(i=>i.disabled=true);
      // Reload attendance to reflect changes
      loadAttendanceBtn.click();
    } else {
      attendanceMsg.style.color='red'; attendanceMsg.textContent = j.error || 'Could not save attendance.';
    }
  }catch(err){ attendanceMsg.style.color='red'; attendanceMsg.textContent='Network error saving attendance.'; console.error(err); }
});

  // Sessions: fetch and render
  async function fetchSessions(){
    try{
      const r = await fetch('list_sessions.php');
      const j = await r.json();
      const sessions = (j && j.success && Array.isArray(j.sessions)) ? j.sessions : [];
      sessionsTableBody.innerHTML = '';
      sessions.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.id}</td><td>${s.course_id}</td><td>${s.group_id}</td><td>${s.date}</td><td>${s.opened_by}</td><td>${s.status}</td><td></td>`;
        const actionTd = tr.querySelector('td:last-child');
        if(s.status === 'open'){
          const btn = document.createElement('button'); btn.textContent='Close'; btn.addEventListener('click',()=>closeSession(s.id)); actionTd.appendChild(btn);
        } else {
          actionTd.textContent = '-';
        }
        sessionsTableBody.appendChild(tr);
      });
    }catch(err){ console.error('Could not load sessions', err); }
  }

  // Create session
  sessionForm.addEventListener('submit', async function(e){
    e.preventDefault();
    const payload = {
      course_id: Number(course_id_input.value) || 0,
      group_id: Number(session_group_input.value) || 0,
      opened_by: Number(opened_by_input.value) || 0,
    };
    if(session_date_input.value) payload.date = session_date_input.value;
    try{
      const r = await fetch('create_session.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await r.json();
      if(j && j.success){ sessionForm.reset(); fetchSessions(); }
      else alert('Could not create session: ' + (j.error||'unknown'));
    }catch(err){ alert('Network or server error creating session'); console.error(err); }
  });

  // Close session
  async function closeSession(id){
    try{
      const r = await fetch('close_session.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ session_id: id }) });
      const j = await r.json();
      if(j && j.success){ fetchSessions(); }
      else alert('Could not close session: ' + (j.error||'unknown'));
    }catch(err){ alert('Network or server error closing session'); console.error(err); }
  }

  // initial load
  fetchSessions();

  // Populate session select
  async function populateSessionSelect(){
    try{
      const r = await fetch('list_sessions.php');
      const j = await r.json();
      const sessions = (j && j.success && Array.isArray(j.sessions)) ? j.sessions : [];
      sessionSelect.innerHTML = '<option value="">-- Select Session --</option>';
      sessions.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `Session ${s.id} - Course ${s.course_id} - ${s.date}`;
        sessionSelect.appendChild(opt);
      });
      return Promise.resolve(); // Ensure it returns a promise
    }catch(err){ console.error('Could not load sessions for select', err); return Promise.reject(err); }
  }

  // Load attendance for the selected session
  async function loadAllAttendance(){
    try{
      const selectedSessionId = sessionSelect.value;
      if(!selectedSessionId) return;

      // Load attendance for the selected session
      const r = await fetch(`attendance_api.php?session_id=${selectedSessionId}`);
      const j = await r.json();
      const attendance = (j && j.success && Array.isArray(j.attendance)) ? j.attendance : [];

      // Build currentAttendance as { studentId: { presence, participation } }
      currentAttendance = {};
      attendance.forEach(att => {
        currentAttendance[att.student_id] = { presence: att.presence, participation: att.participation };
      });

      // Update checkboxes for all students
      const rows = attendanceTable.rows;
      for(let i=1; i<rows.length; i++){
        const row = rows[i];
        const studentId = row.cells[0].textContent;
        const att = currentAttendance[studentId] || { presence: 0, participation: 0 };
        const presenceCb = row.cells[3].querySelector('input');
        if(presenceCb) presenceCb.checked = att.presence == 1;
        const participationCb = row.cells[5].querySelector('input');
        if(participationCb) participationCb.checked = att.participation == 1;
        updateRow(row);
      }
    }catch(err){ console.error('Could not load attendance', err); }
  }

  loadAttendanceBtn.addEventListener('click', loadAllAttendance);

  // Save attendance when checkbox changes
  attendanceTable.addEventListener('change', async function(e){
    if(e.target.type !== 'checkbox') return;
    const row = e.target.closest('tr');
    const studentId = row.cells[0].textContent;
    const sessionId = sessionSelect.value;
    if(!sessionId) return;
    const isPresence = row.cells[3].contains(e.target);
    const isParticipation = row.cells[5].contains(e.target);
    if(!isPresence && !isParticipation) return;
    const studentAtt = currentAttendance[studentId] || { presence: 0, participation: 0 };
    const presence = isPresence ? (e.target.checked ? 1 : 0) : studentAtt.presence;
    const participation = isParticipation ? (e.target.checked ? 1 : 0) : studentAtt.participation;
    try{
      const res = await fetch('attendance_api.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          session_id: sessionId,
          student_id: studentId,
          presence: presence,
          participation: participation
        })
      });
      const j = await res.json();
      if(j && j.success){
        currentAttendance[studentId] = { presence, participation };
        updateRow(row);
      } else {
        alert('Could not save attendance: ' + (j.error || 'unknown'));
        // Revert checkbox
        e.target.checked = !e.target.checked;
      }
    }catch(err){
      console.error('Could not save attendance', err);
      // Revert checkbox
      e.target.checked = !e.target.checked;
    }
  });

  // Initial populate
  populateSessionSelect().then(() => {
    // Auto-load attendance if session is stored
    if (currentSessionId) {
      sessionSelect.value = currentSessionId;
      loadAttendanceBtn.click();
    }
  });

/* Report Chart */
showReport.onclick=()=>{
  const rows=[...attendanceTable.rows].slice(1);
  const total=rows.length;
  const present=rows.filter(r=>parseInt(r.cells[4].textContent) === 0).length;
  const participated=rows.filter(r=>r.querySelector("td:nth-child(5) input") && r.querySelector("td:nth-child(5) input").checked).length;

  reportSection.style.display="block";
  new Chart(reportChart,{
    type:"bar",
    data:{ labels:["Total","Present","Participated"],
      datasets:[{ data:[total,present,participated], backgroundColor:["#fff6b2","#d7f7d0","#bde3ff"] }]
    },
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
};

/* Highlight Excellent */
highlightExcellent.onclick=()=>$("#attendanceTable tr").each(function(){
  if(parseInt($(this).find("td:nth-child(4)").text())<3)
    $(this).css("background","#c4ffcf");
});
resetColors.onclick=()=>location.reload();

/* Search for Attendance Table */
$("#attendance .form-group input[id='search']").on("keyup",function(){
  const v=this.value.toLowerCase();
  $("#attendanceTable tr").filter(function(){
    $(this).toggle($(this).text().toLowerCase().includes(v));
  });
});

/* Search for Students Table */
$("#students .form-group input[id='search']").on("keyup",function(){
  const v=this.value.toLowerCase();
  $("#studentsTable tr").filter(function(){
    $(this).toggle($(this).text().toLowerCase().includes(v));
  });
});

/* Sort */
sortAbs.onclick=()=>{
  const r=$("#attendanceTable tr").slice(1).get().sort((a,b)=>parseInt(a.cells[4].textContent)-parseInt(b.cells[4].textContent));
  $("#attendanceTable").append(r); sortMessage.textContent="Sorted by absences";
};
sortPar.onclick=()=>{
  const r=$("#attendanceTable tr").slice(1).get().sort((a,b)=>$(b).find("td:nth-child(6) input:checked").length-$(a).find("td:nth-child(6) input:checked").length);
  $("#attendanceTable").append(r); sortMessage.textContent="Sorted by participation";
};

// LocalStorage fallback functions
function getStoredStudents(){
  try{
    const stored = localStorage.getItem('students');
    return stored ? JSON.parse(stored) : [];
  }catch(e){ return []; }
}
function saveStoredStudents(students){
  try{ localStorage.setItem('students', JSON.stringify(students)); }catch(e){}
}
</script>

</body>
</html>
