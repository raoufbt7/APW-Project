<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance System</title>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f3f3f3; }
.navbar { background:#333; overflow:hidden; }
.navbar a { float:left; color:#fff; padding:14px 18px; text-decoration:none; }
.navbar a:hover { background:#575757; }
.container { padding:20px; }

table { width:100%; border-collapse:collapse; background:white; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#e0e0e0; }

.low { background:#d7f7d0; }
.medium { background:#fff6b2; }
.high { background:#f5b2b2; }

button, input[type="submit"]{
  background:#333; color:white; padding:8px 14px; border:none; border-radius:6px;
  cursor:pointer; transition:.3s; margin:3px;
}
button:hover, input[type="submit"]:hover { background:#575757; transform:translateY(-2px); }

input[type="text"], input[type="email"] {
  width:95%; padding:6px; margin-top:4px; border-radius:6px; border:1px solid #aaa;
}
#search { width:220px; }

form { background:white; width:420px; padding:15px; border-radius:6px; border:1px solid #ccc; }
label { display:block; margin-top:8px; }
span.error { color:red; font-size:13px; display:block; }

#sortMessage { margin-top:8px; font-weight:bold; color:#444; }

#attendanceTable tr { transition: background-color .5s; }

</style>
</head>
<body>

<div class="navbar">
  <a href="#">Home</a>
  <a href="take_attendance.php">Attendance</a>
  <a href="#add">Add Student</a>
</div>

<div class="container">

<!-- Attendance Table -->
<table id="attendanceTable">
  <tr>
    <th>ID</th><th>Full Name</th><th>Matricule</th>
    <th colspan="6">Sessions</th>
    <th>Absences</th>
    <th colspan="6">Participation</th>
    <th>Message</th>
  </tr>

  <tr>
    <td>1001</td><td>Boukhalfa</td><td>Amine</td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td></td>
  </tr>

  <tr>
    <td>1002</td><td>Saidi</td><td>Rania</td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox" checked></td>
    <td></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td></td>
  </tr>

  <tr>
    <td>1003</td><td>Djelloul</td><td>Yacine</td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox" checked></td>
    <td></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox" checked></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td><input type="checkbox"></td>
    <td></td>
  </tr>
</table>

<br>

<button id="showReport">Show Report</button>
<div id="reportSection" style="display:none; margin-top:10px;">
<canvas id="reportChart" width="350" height="180"></canvas>
</div>

<br>

<input type="text" id="search" placeholder="Search by name...">
<button id="sortAbs">Sort by Absences</button>
<button id="sortPar">Sort by Participation</button>
<div id="sortMessage"></div>

<br>
<!-- Take Attendance -->
<div id="attendanceArea" style="margin-top:12px;">
  <button id="takeAttendanceBtn">Take Attendance</button>
  <div id="attendanceFormContainer" style="display:none; margin-top:10px;">
    <form id="attendanceForm">
      <table id="attendanceList" style="width:100%; max-width:700px; border-collapse:collapse; background:white;">
        <tr><th style="text-align:left;">Student ID</th><th style="text-align:left;">Name</th><th>Present</th><th>Absent</th></tr>
      </table>
      <div style="margin-top:8px;"><input type="submit" value="Save Attendance"><span id="attendanceMsg" style="margin-left:12px; font-weight:bold;"></span></div>
    </form>
  </div>
</div>

<!-- Session Management -->
<div id="sessionArea" style="margin-top:18px;">
  <h3>Sessions</h3>
  <form id="sessionForm" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <label>Course ID: <input type="number" id="course_id" style="width:90px"></label>
    <label>Group ID: <input type="number" id="session_group_id" style="width:90px"></label>
    <label>Professor ID: <input type="number" id="opened_by" style="width:90px"></label>
    <label>Date (optional): <input type="date" id="session_date"></label>
    <input type="submit" value="Create Session">
  </form>

  <table id="sessionsTable" style="width:100%; margin-top:10px; border-collapse:collapse; background:white;">
    <thead><tr><th>ID</th><th>Course</th><th>Group</th><th>Date</th><th>Opened By</th><th>Status</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<br>

<button id="highlightExcellent">Highlight Excellent Students</button>
<button id="resetColors">Reset Colors</button>

<br><br>

<!-- Add Student Form -->
<form id="studentForm">
  <label>Full Name: <input type="text" id="fullname"></label><span id="fullnameError" class="error"></span>
  <label>Matricule: <input type="text" id="matricule"></label><span id="matriculeError" class="error"></span>
  <label>Group ID (optional): <input type="text" id="group_id"></label>
  <input type="submit" value="Add Student">
</form>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Ensure important DOM elements are referenced explicitly
const attendanceTable = document.getElementById('attendanceTable');
const studentForm = document.getElementById('studentForm');
const fullname = document.getElementById('fullname');
const fullnameError = document.getElementById('fullnameError');
const matricule = document.getElementById('matricule');
const matriculeError = document.getElementById('matriculeError');
const group_id = document.getElementById('group_id');
const showReport = document.getElementById('showReport');
const reportSection = document.getElementById('reportSection');
const reportChart = document.getElementById('reportChart');
const sortAbs = document.getElementById('sortAbs');
const sortPar = document.getElementById('sortPar');
const sortMessage = document.getElementById('sortMessage');
const highlightExcellent = document.getElementById('highlightExcellent');
const resetColors = document.getElementById('resetColors');
const takeAttendanceBtn = document.getElementById('takeAttendanceBtn');
const attendanceFormContainer = document.getElementById('attendanceFormContainer');
const attendanceForm = document.getElementById('attendanceForm');
const attendanceMsg = document.getElementById('attendanceMsg');
const sessionForm = document.getElementById('sessionForm');
const sessionsTableBody = document.querySelector('#sessionsTable tbody');
const course_id_input = document.getElementById('course_id');
const session_group_input = document.getElementById('session_group_id');
const opened_by_input = document.getElementById('opened_by');
const session_date_input = document.getElementById('session_date');
function updateRow(row){
  const sess=[...row.querySelectorAll("td:nth-child(n+4):nth-child(-n+9) input")];
  const abs=sess.filter(cb=>!cb.checked).length;
  row.cells[9].textContent=abs+" Abs";

  const parts=[...row.querySelectorAll("td:nth-child(n+11):nth-child(-n+16) input")].filter(cb=>cb.checked).length;

  let msg="";
  if(abs>=5) msg="Excluded – too many absences – Participate more";
  else if(abs>=3) msg="Warning – Low attendance – Participate more";
  else if(parts>=4) msg="Good attendance – Excellent participation";
  else msg="Good attendance – Try to participate more";

  row.cells[16].textContent=msg;

  row.classList.remove("low","medium","high");
  if(abs<3) row.classList.add("low");
  else if(abs<5) row.classList.add("medium");
  else row.classList.add("high");
}

document.querySelectorAll("#attendanceTable tr").forEach((r,i)=>{
  if(i>0){
    updateRow(r);
    r.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.addEventListener("change",()=>updateRow(r)));
  }
});

/* Hover fix */
$("#attendanceTable tr").hover(
  function(){ $(this).css("background","#e7eef8"); },
  function(){ $(this).css("background",""); updateRow(this); }
);

/* Click info */
$("#attendanceTable tr").click(function(){
  const n=$(this).find("td:nth-child(2)").text()+" "+$(this).find("td:nth-child(3)").text();
  const a=$(this).find("td:nth-child(10)").text();
  if(n.trim()) alert(n+" | "+a);
});

/* Add Student */
studentForm.addEventListener("submit",e=>{
  e.preventDefault();
  fullnameError.textContent=matriculeError.textContent="";

  if(!fullname.value.trim()) return fullnameError.textContent="Full name required.";
  if(!/^[A-Za-z0-9\s\-]+$/.test(matricule.value)) return matriculeError.textContent="Invalid matricule.";

  // send the new student to server so it is stored in DB
  const payload = { fullname: fullname.value.trim(), matricule: matricule.value.trim(), group_id: group_id.value ? Number(group_id.value) : null };
  postStudentToServer(payload).then(res=>{
    if(!res.success){
      if(res.error && res.error.indexOf('exists')!==-1) matriculeError.textContent='Matricule already exists on server.';
      else matriculeError.textContent=res.error||'Could not save student to server.';
      return;
    }
    // server should return the created student with id
    const stud = res.student || { id: res.id, fullname: payload.fullname, matricule: payload.matricule, group_id: payload.group_id };
    addStudentRowFromData(stud);
    if(window.serverStudents && Array.isArray(window.serverStudents)) window.serverStudents.push(stud);
    studentForm.reset();
  }).catch(err=>{
    matriculeError.textContent='Network error saving student.';
    console.error(err);
  });
});

// Load students stored in localStorage and append them to the table
function addStudentRowFromData(data){
  const r = attendanceTable.insertRow(-1);
  r.insertCell(0).textContent = data.id;
  r.insertCell(1).textContent = data.fullname || '';
  r.insertCell(2).textContent = data.matricule || '';
  for(let i=0;i<6;i++){
    const c=r.insertCell(3+i), b=document.createElement("input");
    b.type="checkbox"; b.addEventListener("change",()=>updateRow(r)); c.appendChild(b);
  }
  r.insertCell(9).textContent="0 Abs";
  for(let i=0;i<6;i++){
    const c=r.insertCell(10+i), b=document.createElement("input");
    b.type="checkbox"; c.appendChild(b);
  }
  r.insertCell(16).textContent="";
  updateRow(r);
}

function getStoredStudents(){
  try{ const s = localStorage.getItem('awp_students'); return s?JSON.parse(s):[]; }catch(e){ return []; }
}
function saveStoredStudents(arr){
  try{ localStorage.setItem('awp_students', JSON.stringify(arr)); }catch(e){ console.error('Could not save students', e); }
}

async function postStudentToServer(data){
  try{
    const res = await fetch('add_student.php',{
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
    });
    return await res.json();
  }catch(e){ return { success:false, error: 'Network error' }; }
}

// Load students from server and migrate any localStorage students
(async function loadAndMigrate(){
  try{
    const r = await fetch('list_students.php');
    const j = await r.json();
    const serverStudents = (j && j.success && Array.isArray(j.students)) ? j.students : [];
    serverStudents.forEach(s=>addStudentRowFromData(s));
    // expose for attendance form building
    window.serverStudents = serverStudents;

    // migrate localStorage students into server (if any)
    const local = getStoredStudents();
    for(const s of local){
      const exists = serverStudents.find(ss=>String(ss.id) === String(s.id) || String(ss.matricule) === String(s.matricule));
      if(!exists){
        const res = await postStudentToServer({ fullname: s.fullname || (s.lname + ' ' + s.fname), matricule: s.matricule || s.id, group_id: s.group_id || null });
        if(res && res.success && res.student){ addStudentRowFromData(res.student); }
      }
    }
    if(local.length) saveStoredStudents([]); // clear migrated local cache
  }catch(err){
    console.warn('Could not load server students, falling back to localStorage:', err);
    const stored = getStoredStudents(); stored.forEach(addStudentRowFromData);
  }
})();

// Build attendance form when requested
takeAttendanceBtn.onclick = async () => {
  attendanceFormContainer.style.display = 'block';
  // ensure we have fresh students list
  let students = window.serverStudents;
  if (!students) {
    try{ const r = await fetch('list_students.php'); const j=await r.json(); students=(j && j.success && Array.isArray(j.students))?j.students:[]; window.serverStudents=students; }catch(e){ students=[]; }
  }
  const tbl = document.getElementById('attendanceList');
  // clear existing rows except header
  Array.from(tbl.querySelectorAll('tr')).slice(1).forEach(r=>r.remove());
  students.forEach(s=>{
    const tr = document.createElement('tr');
    const tdId = document.createElement('td'); tdId.style.textAlign='left'; tdId.textContent = s.id; tr.appendChild(tdId);
    const tdName = document.createElement('td'); tdName.style.textAlign='left'; tdName.textContent = s.lname + ' ' + s.fname; tr.appendChild(tdName);
    const tdP = document.createElement('td'); tdP.style.textAlign='center'; const rP = document.createElement('input'); rP.type='radio'; rP.name = `attendance[${s.id}]`; rP.value='present'; rP.checked=true; tdP.appendChild(rP); tr.appendChild(tdP);
    const tdA = document.createElement('td'); tdA.style.textAlign='center'; const rA = document.createElement('input'); rA.type='radio'; rA.name = `attendance[${s.id}]`; rA.value='absent'; tdA.appendChild(rA); tr.appendChild(tdA);
    tbl.appendChild(tr);
  });
};

// Submit attendance to server
attendanceForm.addEventListener('submit', async function(e){
  e.preventDefault();
  attendanceMsg.textContent = '';
  const students = window.serverStudents || [];
  const attendance = [];
  students.forEach(s=>{
    const sel = document.querySelector(`input[name="attendance[${s.id}]"]:checked`);
    const status = sel ? sel.value : 'absent';
    attendance.push({ student_id: String(s.id), status });
  });
  try{
    const res = await fetch('attendance_api.php', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ attendance }) });
    const j = await res.json();
    if (j && j.success) {
      attendanceMsg.style.color='green'; attendanceMsg.textContent = 'Attendance saved: ' + (j.file||'');
      // disable form after save
      Array.from(attendanceForm.querySelectorAll('input')).forEach(i=>i.disabled=true);
    } else {
      attendanceMsg.style.color='red'; attendanceMsg.textContent = j.error || 'Could not save attendance.';
    }
  }catch(err){ attendanceMsg.style.color='red'; attendanceMsg.textContent='Network error saving attendance.'; console.error(err); }
});

  // Sessions: fetch and render
  async function fetchSessions(){
    try{
      const r = await fetch('list_sessions.php');
      const j = await r.json();
      const sessions = (j && j.success && Array.isArray(j.sessions)) ? j.sessions : [];
      sessionsTableBody.innerHTML = '';
      sessions.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.id}</td><td>${s.course_id}</td><td>${s.group_id}</td><td>${s.date}</td><td>${s.opened_by}</td><td>${s.status}</td><td></td>`;
        const actionTd = tr.querySelector('td:last-child');
        if(s.status === 'open'){
          const btn = document.createElement('button'); btn.textContent='Close'; btn.addEventListener('click',()=>closeSession(s.id)); actionTd.appendChild(btn);
        } else {
          actionTd.textContent = '-';
        }
        sessionsTableBody.appendChild(tr);
      });
    }catch(err){ console.error('Could not load sessions', err); }
  }

  // Create session
  sessionForm.addEventListener('submit', async function(e){
    e.preventDefault();
    const payload = {
      course_id: Number(course_id_input.value) || 0,
      group_id: Number(session_group_input.value) || 0,
      opened_by: Number(opened_by_input.value) || 0,
    };
    if(session_date_input.value) payload.date = session_date_input.value;
    try{
      const r = await fetch('create_session.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await r.json();
      if(j && j.success){ sessionForm.reset(); fetchSessions(); }
      else alert('Could not create session: ' + (j.error||'unknown'));
    }catch(err){ alert('Network or server error creating session'); console.error(err); }
  });

  // Close session
  async function closeSession(id){
    try{
      const r = await fetch('close_session.php',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ session_id: id }) });
      const j = await r.json();
      if(j && j.success){ fetchSessions(); }
      else alert('Could not close session: ' + (j.error||'unknown'));
    }catch(err){ alert('Network or server error closing session'); console.error(err); }
  }

  // initial load
  fetchSessions();

/* Report Chart */
showReport.onclick=()=>{
  const rows=[...attendanceTable.rows].slice(1);
  const total=rows.length;
  const present=rows.filter(r=>parseInt(r.cells[9].textContent)<6).length;
  const participated=rows.filter(r=>[...r.querySelectorAll("td:nth-child(n+11) input")].some(cb=>cb.checked)).length;

  reportSection.style.display="block";
  new Chart(reportChart,{
    type:"bar",
    data:{ labels:["Total","Present","Participated"],
      datasets:[{ data:[total,present,participated], backgroundColor:["#fff6b2","#d7f7d0","#bde3ff"] }]
    },
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
};

/* Highlight Excellent */
highlightExcellent.onclick=()=>$("#attendanceTable tr").each(function(){
  if(parseInt($(this).find("td:nth-child(10)").text())<3)
    $(this).css("background","#c4ffcf");
});
resetColors.onclick=()=>location.reload();

/* Search */
$("#search").on("keyup",function(){
  const v=this.value.toLowerCase();
  $("#attendanceTable tr").filter(function(){
    $(this).toggle($(this).text().toLowerCase().includes(v));
  });
});

/* Sort */
sortAbs.onclick=()=>{
  const r=$("#attendanceTable tr").slice(1).get().sort((a,b)=>parseInt(a.cells[9].textContent)-parseInt(b.cells[9].textContent));
  $("#attendanceTable").append(r); sortMessage.textContent="Sorted by absences";
};
sortPar.onclick=()=>{
  const r=$("#attendanceTable tr").slice(1).get().sort((a,b)=>$(b).find("td:nth-child(n+11) input:checked").length-$(a).find("td:nth-child(n+11) input:checked").length);
  $("#attendanceTable").append(r); sortMessage.textContent="Sorted by participation";
};
</script>

</body>
</html>
